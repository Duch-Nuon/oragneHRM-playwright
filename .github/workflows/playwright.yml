name: Playwright Tests
on:
  # push:
  #   branches: [ main ]
  #   paths-ignore:
  #     - "README.md"
  #     - "**/*.md"
  # pull_request:
  #   branches: [ main ]
  #   paths-ignore:
  #     - "README.md"
  #     - "**/*.md"
  repository_dispatch:
    types: [run-playwright]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
        BASE_URL: ${{ secrets.BASE_URL }}
        ORANGEHRM_USER: ${{ secrets.ORANGEHRM_USER }}
        ORANGEHRM_PASS: ${{ secrets.ORANGEHRM_PASS }}
        BASE_MAIL_URL: ${{ secrets.BASE_MAIL_URL }}

    steps:
      - uses: actions/checkout@v5
      
      - name: Enable Corepack (pnpm)
        run: corepack enable
      
      - uses: actions/setup-node@v5
        with:
          node-version: lts/*
          cache: pnpm
      
      - name: Install dependencies (pnpm)
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps
      - name: Run Playwright tests and capture output
        run: pnpm exec playwright test --reporter=list | tee test-summary.txt

      - name: Send Playwright test summary to Telegram
        if: ${{ always() }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          SUMMARY=$(tail -n 30 test-summary.txt)
          # Add emojis for pass/fail/skipped
          SUMMARY=$(echo "$SUMMARY" | sed 's/^  ✓/✅/g' | sed 's/^  ✗/❌/g' | sed 's/^  -/⚠️/g')
          # Escape for MarkdownV2
          ESCAPED_SUMMARY=$(printf '%s' "$SUMMARY" | sed -e 's/`/\\`/g' -e 's/\*/\\*/g' -e 's/_/\\_/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/~/\\~/g' -e 's/>/\\>/g' -e 's/#/\\#/g' -e 's/\+/\\+/g' -e 's/-/\\-/g' -e 's/=/\\=/g' -e 's/|/\\|/g' -e 's/{/\\{/g' -e 's/}/\\}/g' -e 's/\./\\./g' -e 's/!/\\!/g')
          MESSAGE="*Playwright Test Results:*\n\n\`\`\`\n$ESCAPED_SUMMARY\n\`\`\`"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="$MESSAGE" \
            -d parse_mode="MarkdownV2"